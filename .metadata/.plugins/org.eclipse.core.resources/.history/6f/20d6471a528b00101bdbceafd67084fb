#include <stdint.h>
#include <stdio.h>
#include "stm32f411xE.h"
#include "uart.h"
#include "adc.h"
#include "systick.h"
#include "tim.h"

#define GPIOAEN		(1U<<0)
#define	GPIOA_5		(1U<<5)
#define LED			GPIOA_5



uint32_t sensor_value;

static void tim2_callback(void);

int main(void)
{
	/* LED Pin set up */
	RCC->AHB1ENR |= GPIOAEN;	// enable the clock from the AHB1 bus to Port A. Write the enable bit to the Bus register

	// set pin 5 direction. Pin 5 is bits 10 & 11 in the MODE register
	GPIOA->MODER |= (1U<<10);	// set bit 10 to 1
	GPIOA->MODER &=~(1U<<11);	// set bit 11 to 0


	uart2_tx_init(); 		// output to display
	pa1_adc_init();			// adc input pins
	start_conversion();		// start the adc conversion
	tim2_1hz_interrupt_init();

	while(1)
	{

	}
}


static void tim2_callback(void)
{


	sensor_value = ADC1->DR;

	printf("Sensor_value: %d \n\r", (int)sensor_value);
	GPIOA->ODR ^= LED;


}

void TIM2_IRQHandler(void)
{
	if (TIM2->SR & SR_TIF)
	{
		/* clear the interrupt flag */
		TIM2->SR &=~SR_TIF;

		tim2_callback();
	}


}




